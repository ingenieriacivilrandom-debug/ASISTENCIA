<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Asistencia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 30px;
    background-color: #f7f7f7;
  }
  button {
    width: 90%;
    max-width: 320px;
    padding: 15px;
    margin: 10px auto;
    font-size: 18px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    background-color: #2c7be5;
    color: white;
  }
</style>
</head>

<body>

<h2>REGISTRO DE ASISTENCIA</h2>
<p>Ingreso (ubicación solo informativa)</p>

<button onclick="registrar('Juan Perez')">Juan Perez</button>
<button onclick="registrar('Maria Lopez')">Maria Lopez</button>

<script>
// ============ CONFIGURACION ============
const LAT_REF = -10.687371;
const LON_REF = -76.245331;
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwC0IiPUseEh5hPthAcqY0BA5oE1TUksUbG6xX18ZuS_YpJhCGMUtf2jQnazLlxYzNH0Q/exec";
// ======================================

function distancia(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function registrar(nombre) {

  navigator.geolocation.getCurrentPosition(
    pos => {

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;

      const dist = distancia(lat, lon, LAT_REF, LON_REF);
      const ahora = new Date();

      fetch(URL_SCRIPT, {
        method: "POST",
        body: JSON.stringify({
          nombre: nombre,
          fecha: ahora.toISOString().slice(0, 10),
          hora: ahora.toLocaleTimeString(),
          distancia: dist.toFixed(2),
          precision: accuracy.toFixed(2)
        })
      })
      .then(res => res.text())
      .then(respuesta => {
        if (respuesta === "NO_AUTORIZADO") {
          alert("Usuario no autorizado");
        } else if (respuesta === "LIMITE_DIARIO") {
          alert("Ya registró las 2 asistencias del día");
        } else {
          alert(
            "Asistencia registrada\n" +
            "Distancia: " + Math.round(dist) + " m\n" +
            "Precisión GPS: " + Math.round(accuracy) + " m"
          );
        }
      });

    },
    () => {
      alert("Debe permitir acceso a ubicación");
    },
    {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    }
  );
}
</script>

</body>
</html>
