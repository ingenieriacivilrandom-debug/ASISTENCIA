<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Asistencia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 30px;
}
button {
  width: 90%;
  max-width: 300px;
  padding: 15px;
  margin: 10px;
  font-size: 18px;
}
</style>
</head>

<body>

<h2>REGISTRO DE ASISTENCIA</h2>
<p>Click para registrar asistencia</p>

<button onclick="registrar('Rafael')">Rafael</button>
<button onclick="registrar('Ysaac')">Ysaac</button>

<script>
// ===== CONFIGURACIÓN =====
const LAT_REF = -12.0464;      // Coordenada oficina
const LON_REF = -77.0428;
const RADIO_MAX = 150;         // metros
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwC0IiPUseEh5hPthAcqY0BA5oE1TUksUbG6xX18ZuS_YpJhCGMUtf2jQnazLlxYzNH0Q/exec";
// ==========================

function distancia(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1) * Math.PI / 180;
  const dLon = (lon2-lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function registrar(nombre) {
  navigator.geolocation.getCurrentPosition(pos => {

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const dist = distancia(lat, lon, LAT_REF, LON_REF);

    if (dist > RADIO_MAX) {
      alert("Fuera de rango (" + Math.round(dist) + " m)");
      return;
    }

    const ahora = new Date();

    fetch(URL_SCRIPT, {
      method: "POST",
      body: JSON.stringify({
        nombre: nombre,
        fecha: ahora.toISOString().slice(0,10),
        hora: ahora.toLocaleTimeString(),
        distancia: dist.toFixed(2)
      })
    })
    .then(res => res.text())
    .then(respuesta => {
      if (respuesta === "LIMITE_DIARIO") {
        alert("Ya marcó 2 veces hoy");
      } else {
        alert("Asistencia registrada correctamente");
      }
    });

  }, () => {
    alert("Debe permitir ubicación GPS");
  }, { enableHighAccuracy: true });
}
</script>

</body>
</html>
