<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Asistencia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 30px;
    background-color: #f7f7f7;
  }
  h2 {
    margin-bottom: 10px;
  }
  button {
    width: 90%;
    max-width: 320px;
    padding: 15px;
    margin: 10px auto;
    font-size: 18px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    background-color: #2c7be5;
    color: white;
  }
  button:active {
    background-color: #1a5fc1;
  }
</style>
</head>

<body>

<h2>REGISTRO DE ASISTENCIA</h2>
<p>Solo ingreso – Máximo 2 veces por día</p>

<!-- ===== BOTONES (CAMBIAR NOMBRES SI ES NECESARIO) ===== -->
<button onclick="registrar('Rafael')">Rafael</button>
<button onclick="registrar('Ysaac')">Ysaac</button>
<!-- ===================================================== -->

<script>
// ================= CONFIGURACIÓN =================
const LAT_REF = -10.687371;      // COORDENADA REAL DE LA OFICINA
const LON_REF = -76.245331;
const RADIO_MAX = 300;           // Radio permitido (metros)
const MAX_ACCURACY = 100;        // Precisión GPS máxima aceptada
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwC0IiPUseEh5hPthAcqY0BA5oE1TUksUbG6xX18ZuS_YpJhCGMUtf2jQnazLlxYzNH0Q/exec";
// ================================================

// CALCULO DE DISTANCIA (HAVERSINE)
function distancia(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function registrar(nombre) {

  if (!navigator.geolocation) {
    alert("Este dispositivo no soporta GPS");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;

      // VALIDAR PRECISIÓN GPS
      if (accuracy > MAX_ACCURACY) {
        alert(
          "Ubicación imprecisa (" + Math.round(accuracy) + " m).\n" +
          "Active GPS en alta precisión y espere unos segundos."
        );
        return;
      }

      // CALCULAR DISTANCIA
      const dist = distancia(lat, lon, LAT_REF, LON_REF);

      if (dist > RADIO_MAX) {
        alert(
          "Fuera de rango.\n" +
          "Distancia: " + Math.round(dist) + " m"
        );
        return;
      }

      const ahora = new Date();

      // ENVIAR A GOOGLE SHEETS
      fetch(URL_SCRIPT, {
        method: "POST",
        body: JSON.stringify({
          nombre: nombre,
          fecha: ahora.toISOString().slice(0, 10),
          hora: ahora.toLocaleTimeString(),
          distancia: dist.toFixed(2)
        })
      })
      .then(res => res.text())
      .then(respuesta => {
        if (respuesta === "NO_AUTORIZADO") {
          alert("Usuario no autorizado");
        } else if (respuesta === "LIMITE_DIARIO") {
          alert("Ya registró las 2 asistencias del día");
        } else {
          alert("Asistencia registrada correctamente");
        }
      })
      .catch(() => {
        alert("Error al registrar. Verifique conexión.");
      });

    },
    () => {
      alert("Debe permitir el acceso a la ubicación");
    },
    {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    }
  );
}
</script>

</body>
</html>
